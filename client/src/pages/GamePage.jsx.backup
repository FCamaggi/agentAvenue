import { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useSocket } from '../contexts/SocketContext';
import { useGame } from '../contexts/GameContext';
import GameBoard from '../components/GameBoard';
import PlayerHand from '../components/PlayerHand';
import RecruitedAgents from '../components/RecruitedAgents';
import Card from '../components/Card';
import { LogOut, Info } from 'lucide-react';

const GamePage = () => {
  const { gameId } = useParams();
  const navigate = useNavigate();
  const { socket } = useSocket();
  const { state, dispatch } = useGame();

  const [selectedHandCards, setSelectedHandCards] = useState([]);
  const [playedCards, setPlayedCards] = useState({
    faceUp: null,
    faceDown: null,
  });
  const [recruitChoice, setRecruitChoice] = useState(null);
  const [showRules, setShowRules] = useState(false);
  const [cardToDiscard, setCardToDiscard] = useState(null);
  const [showDiscardConfirm, setShowDiscardConfirm] = useState(false);
  const [blackMarketSupply, setBlackMarketSupply] = useState([]);

  useEffect(() => {
    if (!socket) return;

    // Recibir estado inicial del juego
    socket.emit('get-game-state', { gameId });

    // Escuchar actualizaciones del juego
    socket.on('game-state-updated', (data) => {
      dispatch({ type: 'UPDATE_GAME_STATE', payload: data.gameState });

      // Actualizar mano del jugador
      const myPlayer = data.gameState.players.find(
        (p) => p.id === state.playerId,
      );
      if (myPlayer) {
        dispatch({ type: 'UPDATE_HAND', payload: myPlayer.hand });
        dispatch({
          type: 'UPDATE_RECRUITED',
          payload: myPlayer.recruitedAgents,
        });
        dispatch({
          type: 'SET_TURN',
          payload: data.gameState.currentPlayer === state.playerId,
        });
        // Actualizar descartes restantes
        if (myPlayer.discardsRemaining !== undefined) {
          dispatch({
            type: 'SET_DISCARDS_REMAINING',
            payload: myPlayer.discardsRemaining,
          });
        }
      }

      // Actualizar oferta del Mercado Negro
      if (data.gameState.blackMarketSupply) {
        setBlackMarketSupply(data.gameState.blackMarketSupply);
      }
    });

    socket.on('cards-played', (data) => {
      setPlayedCards({ faceUp: data.faceUp, faceDown: data.faceDown });
      dispatch({ type: 'SET_PHASE', payload: 'recruiting' });
    });

    socket.on('agent-recruited', (data) => {
      console.log('Agente reclutado:', data);
      setPlayedCards({ faceUp: null, faceDown: null });
      setRecruitChoice(null);
      dispatch({ type: 'SET_PHASE', payload: 'playing' });
    });

    socket.on('game-over', (data) => {
      dispatch({ type: 'GAME_OVER', payload: data.winner });
    });

    socket.on('player-disconnected', (data) => {
      console.log('Jugador desconectado:', data);
    });

    socket.on('error', (error) => {
      dispatch({ type: 'SET_ERROR', payload: error.message });
      setTimeout(() => dispatch({ type: 'CLEAR_ERROR' }), 5000);
    });

    socket.on('card-discarded', (data) => {
      console.log('Carta descartada:', data);
      dispatch({
        type: 'SET_DISCARDS_REMAINING',
        payload: data.discardsRemaining,
      });
    });

    socket.on('black-market-taken', (data) => {
      console.log('Carta del Mercado Negro tomada:', data);
      if (data.playerId === state.playerId) {
        dispatch({ type: 'ADD_BLACK_MARKET_CARD', payload: data.card });
      }
    });

    return () => {
      socket.off('game-state-updated');
      socket.off('cards-played');
      socket.off('agent-recruited');
      socket.off('game-over');
      socket.off('player-disconnected');
      socket.off('error');
      socket.off('card-discarded');
      socket.off('black-market-taken');
    };
  }, [socket, gameId, dispatch, state.playerId]);

  const handleCardSelect = (card, index) => {
    if (state.phase !== 'playing' || !state.isMyTurn) return;

    setSelectedHandCards((prev) => {
      if (prev.includes(index)) {
        return prev.filter((i) => i !== index);
      }
      if (prev.length >= 2) {
        return prev;
      }
      return [...prev, index];
    });
  };

  const handlePlayCards = () => {
    if (selectedHandCards.length !== 2) return;

    const cards = selectedHandCards.map((i) => state.hand[i]);

    // Verificar que sean diferentes
    if (cards[0].name === cards[1].name) {
      dispatch({
        type: 'SET_ERROR',
        payload: 'Debes jugar dos cartas diferentes',
      });
      return;
    }

    socket.emit('play-cards', {
      gameId,
      faceUpIndex: selectedHandCards[0],
      faceDownIndex: selectedHandCards[1],
    });

    setSelectedHandCards([]);
  };

  const handleRecruitChoice = (cardType) => {
    if (state.phase !== 'recruiting' || state.isMyTurn) return;

    setRecruitChoice(cardType);
    socket.emit('recruit-agent', {
      gameId,
      choice: cardType, // 'faceUp' | 'faceDown'
    });
  };

  const handleDiscardCard = (cardIndex) => {
    if (state.discardsRemaining <= 0) {
      dispatch({
        type: 'SET_ERROR',
        payload: 'No te quedan descartes disponibles',
      });
      setTimeout(() => dispatch({ type: 'CLEAR_ERROR' }), 3000);
      return;
    }

    setCardToDiscard(cardIndex);
    setShowDiscardConfirm(true);
  };

  const confirmDiscard = () => {
    if (cardToDiscard !== null) {
      socket.emit('discard-card', {
        gameId,
        cardIndex: cardToDiscard,
      });
      setCardToDiscard(null);
      setShowDiscardConfirm(false);
    }
  };

  const cancelDiscard = () => {
    setCardToDiscard(null);
    setShowDiscardConfirm(false);
  };

  const handleLeaveGame = () => {
    if (confirm('¬øSeguro que quieres abandonar el juego?')) {
      socket.emit('leave-game', { gameId });
      navigate('/');
    }
  };

  const getPhaseMessage = () => {
    if (state.phase === 'finished') {
      return state.winner === state.playerId ? '¬°Has ganado!' : 'Has perdido';
    }

    if (!state.isMyTurn && state.phase === 'recruiting') {
      return 'Elige qu√© agente reclutar';
    }

    if (state.isMyTurn && state.phase === 'playing') {
      return 'Tu turno: Juega 2 cartas';
    }

    if (state.isMyTurn && state.phase === 'recruiting') {
      return 'Esperando que el oponente reclute...';
    }

    return 'Esperando al oponente...';
  };

  const opponent = state.gameState?.players.find(
    (p) => p.id !== state.playerId,
  );

  return (
    <div className="min-h-screen p-2 sm:p-4 pb-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="flex justify-between items-center mb-4 sm:mb-6">
          <div>
            <h1 className="text-xl sm:text-2xl font-bold text-white">Agent Avenue</h1>
            <p className="text-slate-400 text-xs sm:text-sm">
              Modo:{' '}
              {state.gameMode === 'simple'
                ? 'Simple'
                : state.gameMode === 'advanced'
                  ? 'Avanzado'
                  : 'Equipos'}
            </p>
          </div>

          <div className="flex gap-2 sm:gap-3">
            <button
              onClick={() => setShowRules(!showRules)}
              className="p-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
            >
              <Info className="w-4 h-4 sm:w-5 sm:h-5" />
            </button>
            <button
              onClick={handleLeaveGame}
              className="p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
            >
              <LogOut className="w-4 h-4 sm:w-5 sm:h-5" />
            </button>
          </div>
        </div>

        {/* Fase del juego */}
        <div className="bg-slate-800 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6 border border-slate-700">
          <div className="flex items-center justify-between flex-wrap gap-2">
            <div className="flex-1 min-w-0">
              <h2 className="text-base sm:text-xl font-semibold text-white truncate">
                {getPhaseMessage()}
              </h2>
              {state.isMyTurn && (
                <div className="flex items-center gap-2 mt-1">
                  <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                  <span className="text-green-400 text-xs sm:text-sm">Tu turno</span>
                </div>
              )}
            </div>

            <div className="flex items-center gap-3 sm:gap-4">
              {state.gameState && (
                <div className="text-slate-400 text-xs sm:text-sm">
                  Turno {state.gameState.turnNumber || 1}
                </div>
              )}
              
              {/* Indicador de descartes */}
              {state.isMyTurn && state.phase === 'playing' && (
                <div className="text-xs sm:text-sm text-slate-300 bg-slate-700 px-2 sm:px-3 py-1 rounded-full">
                  üîÑ {state.discardsRemaining} descartes
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Error */}
        {state.error && (
          <div className="bg-red-500/10 border border-red-500 text-red-400 px-3 sm:px-4 py-2 sm:py-3 rounded-lg mb-4 sm:mb-6 text-sm shake">
            {state.error}
          </div>
        )}

        {/* Layout principal */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
          {/* Columna izquierda: Tablero */}
          <div className="lg:col-span-2 space-y-4 sm:space-y-6">\n            <GameBoard
              gameState={state.gameState}
              isAdvancedMode={state.gameMode === 'advanced'}
            />

            {/* Cartas jugadas */}
            {(playedCards.faceUp || playedCards.faceDown) && (
              <div className="bg-slate-800 rounded-xl p-3 sm:p-4 border border-slate-700">
                <h3 className="text-white font-semibold mb-3 text-sm sm:text-base">
                  Cartas Jugadas
                </h3>
                <div className="flex gap-3 sm:gap-4 justify-center flex-wrap sm:flex-nowrap">
                  {playedCards.faceUp && (
                    <div
                      onClick={() =>
                        !state.isMyTurn && handleRecruitChoice('faceUp')
                      }
                      className={`${!state.isMyTurn ? 'cursor-pointer transform hover:scale-105 transition-transform' : ''} flex-shrink-0`}
                    >
                      <Card
                        agent={playedCards.faceUp}
                        faceUp={true}
                        size="lg"
                        selected={recruitChoice === 'faceUp'}
                      />
                      <p className="text-center text-white text-xs sm:text-sm mt-2">
                        Boca Arriba
                      </p>
                    </div>
                  )}
                  {playedCards.faceDown && (
                    <div
                      onClick={() =>
                        !state.isMyTurn && handleRecruitChoice('faceDown')
                      }
                      className={`${!state.isMyTurn ? 'cursor-pointer transform hover:scale-105 transition-transform' : ''} flex-shrink-0`}
                    >
                      <Card
                        agent={playedCards.faceDown}
                        faceUp={!state.isMyTurn || state.phase === 'finished'}
                        size="lg"
                        selected={recruitChoice === 'faceDown'}
                      />
                      <p className="text-center text-white text-xs sm:text-sm mt-2">
                        Boca Abajo
                      </p>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Mercado Negro (solo modo avanzado) */}
            {state.gameMode === 'advanced' && blackMarketSupply.length > 0 && (
              <div className="bg-s4 sm:space-y-6">
            {/* Oponente */}
            {opponent && (
              <RecruitedAgents
                agents={opponent.recruitedAgents}
                playerName={opponent.name}
                isOpponent={true}
              />
            )}

            {/* Tus agentes */}
            <RecruitedAgents
              agents={state.recruitedAgents}
              playerName={state.playerName}
              isOpponent={false}
            />
          </div>
        </div>

        {/* Tu mano */}
        <div className="mt-4 sm:mt-6">
          <PlayerHand
            cards={state.hand}
            onCardClick={handleCardSelect}
            selectedCards={selectedHandCards}
            disabled={!state.isMyTurn || state.phase !== 'playing'}
            maxSelection={2}
          />

          {/* Botones de acci√≥n */}
          {state.isMyTurn && state.phase === 'playing' && (
            <div className="mt-4 flex flex-col sm:flex-row justify-center gap-3">
              <button
                onClick={handlePlayCards}
                disabled={selectedHandCards.length !== 2}
                className="bg-game-teal hover:bg-teal-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 sm:px-8 rounded-xl transition-all shadow-lg text-sm sm:text-base"
              >
                ‚ñ∂Ô∏è Jugar Cartas Seleccionadas
              </button>

              {state.discardsRemaining > 0 && selectedHandCards.length === 1 && (
                <button
                  onClick={() => handleDiscardCard(selectedHandCards[0])}
                  className="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 sm:px-8 rounded-xl transition-all shadow-lg text-sm sm:text-base"
                >
                  üîÑ Descartar y Robar ({state.discardsRemaining} restantes)
                </button>
              )}gents
              agents={state.recruitedAgents}
              playerName={state.playerName}
              isOpponent={false}
            />
          </div>
        </div>

        {/* Tu mano */}
        <div className="mt-6">
          <PlayerHand
            cards={state.hand}
            onCardClick={handleCardSelect}
            selectedCards={selectedHandCards}
            disabled={!state.isMyTurn || state.phase !== 'playing'}
            maxSelection={2}
          />

          {state.isMyTurn && state.phase === 'playing' && (
            <div className="mt-4 flex justify-center">
              <button
                onClick={handlePlayCards}
                disabled={selectedHandCards.length !== 2}
                className="bg-game-teal hover:bg-teal-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-8 rounded-xl transition-all shadow-lg"
              >
                Jugar Cartas Seleccionadas
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Modal de confirmaci√≥n de descarte */}
      {showDiscardConfirm && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-2xl p-6 max-w-sm border border-slate-700 shake">
            <h2 className="text-xl font-bold text-white mb-4">
              ¬øDescartar carta?
            </h2>
            <p className="text-slate-300 mb-6">
              Descartar√°s esta carta y robar√°s una nueva. Te quedar√°n{' '}
              <span className="text-game-teal font-bold">
                {state.discardsRemaining - 1}
              </span>{' '}
              descartes disponibles en esta partida.
            </p>
            <div className="flex gap-3">
              <button
                onClick={cancelDiscard}
                className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 rounded-xl transition-all"
              >
                Cancelar
              </button>
              <button
                onClick={confirmDiscard}
                className="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-xl transition-all"
              >
                Confirmar
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal de reglas */}
      {showRules && (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
          <div className="bg-slate-800 rounded-2xl p-4 sm:p-6 max-w-2xl max-h-[80vh] overflow-y-auto">
            <h2 className="text-xl sm:text-2xl font-bold text-white mb-4">
              Reglas del Juego
            </h2>
            <div className="text-slate-300 space-y-3 text-sm sm:text-base">
              <p>
                <strong>Objetivo:</strong> Captura el pe√≥n de tu oponente antes
                de que capture el tuyo.
              </p>
              <p>
                <strong>Turno:</strong>
              </p>
              <ol className="list-decimal list-inside space-y-1 ml-4">
                <li>Juega 2 cartas diferentes (1 boca arriba, 1 boca abajo)</li>
                <li>
                  Tu oponente elige una carta para reclutar, t√∫ obtienes la otra
                </li>
                <li>Ambos mueven sus peones seg√∫n el agente reclutado</li>
              </ol>
              <p>
                <strong>Movimiento:</strong> Seg√∫n cu√°ntos agentes del mismo tipo tengas:
              </p>
              <ul className="list-disc list-inside space-y-1 ml-4">
                <li>1 agente: usa el 1er s√≠mbolo (arriba)</li>
                <li>2 agentes: usa el 2do s√≠mbolo (medio)</li>
                <li>3+ agentes: usa el 3er s√≠mbolo (abajo)</li>
              </ul>
              <p>
                <strong>Descarte:</strong> Puedes descartar una carta y robar una nueva hasta 4 veces por partida.
              </p>
              <p>
                <strong>Victoria:</strong>
              </p>
              <ul className="list-disc list-inside space-y-1 ml-4">
                <li>Captura el pe√≥n del oponente</li>
                <li>Recluta 3 Codebreakers</li>
              </ul>
              <p>
                <strong>Derrota:</strong>
              </p>
              <ul className="list-disc list-inside space-y-1 ml-4">
                <li>Recluta 3 Daredevils</li>
              </ul>
              {state.gameMode === 'advanced' && (
                <>
                  <p className="text-yellow-400 font-semibold mt-4">
                    <strong>Modo Avanzado - Mercado Negro:</strong>
                  </p>
                  <p>
                    Al caer EXACTAMENTE en una casilla del Mercado Negro (esquinas), tomas una carta especial con efectos √∫nicos.
                  </p>
                </>
              )}
            </div>
            <button
              onClick={() => setShowRules(false)}
              className="mt-6 w-full bg-game-teal hover:bg-teal-600 text-white font-semibold py-3 rounded-xl transition-all"
            >
              Cerrar
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default GamePage;
